<section class="pb-8" data-testid="inscription-page" data-controller="inscription"
    data-action="wallet:connected@window->inscription#onWalletConnected wallet:disconnected@window->inscription#onWalletDisconnected"
    data-inscription-price-value="<%= checkout.priceSats %>"
    data-inscription-inscription-metadata-value="<%= JSON.stringify(inscription.metadata) %>"
    data-inscription-payment-address-value="<%= config.payment_address %>">
    <% if (config.parent_inscription_id || config.gallery_inscription_id) { %>
        <% const isGallery=Boolean(config.gallery_inscription_id) %>
            <% const bannerId=isGallery ? config.gallery_inscription_id : config.parent_inscription_id %>
                <div class="mb-8 flex items-center gap-4" data-testid="parent-banner">
                    <a class="text-sm text-white/40 hover:text-white/60 transition-colors"
                        href="/<%= encodeURIComponent(config.slug) %>" data-testid="parent-collection-link">← <%=
                            config.title %></a>
                </div>
                <% } %>

                    <h1 class="text-xl font-medium text-white/95" data-testid="page-title">
                        <%= title %>
                    </h1>

                    <div class="mt-10 grid grid-cols-1 gap-12 lg:grid-cols-2">
                        <!-- Media -->
                        <div>
                            <div class="relative aspect-square overflow-hidden rounded-xl bg-[#111113]"
                                data-testid="media" data-controller="image">
                                <div class="absolute inset-0 img-placeholder" data-image-target="skeleton"></div>
                                <% if (inscription.isImage) { %>
                                    <img src="<%= inscription.contentUrl %>" alt="<%= title %>" loading="eager"
                                        decoding="async" style="image-rendering: pixelated"
                                        class="block h-full w-full object-contain opacity-0 transition-opacity duration-300"
                                        data-image-target="img" data-action="load->image#loaded error->image#error"
                                        data-testid="inscription-media-img" />
                                    <% } else { %>
                                        <iframe src="<%= inscription.previewUrl %>"
                                            class="block h-full w-full border-0 pointer-events-none opacity-0 transition-opacity duration-300"
                                            allow="accelerometer; gyroscope" data-image-target="media"
                                            data-action="load->image#loaded error->image#error"
                                            data-testid="inscription-media-iframe"></iframe>
                                        <% } %>
                            </div>
                        </div>

                        <!-- Details & Purchase -->
                        <div class="space-y-8">
                            <!-- Price -->
                            <% if (order.status==='pending' || order.status==='confirmed' ) { %>
                                <%- include('partials/order', { order }) %>
                                    <% } else { %>
                                        <div data-testid="price-card">
                                            <div class="text-sm text-white/40">Price</div>
                                            <div class="mt-2 price text-3xl" data-testid="price-sats">
                                                <%= formatSats(checkout.priceSats) %>
                                            </div>
                                            <div class="hidden mt-1 font-mono text-sm text-white/30"
                                                data-usd-sats="<%= checkout.priceSats %>"></div>
                                        </div>

                                        <!-- Purchase Form -->
                                        <div class="card rounded-xl p-6" data-testid="purchase-panel">
                                            <form method="post" data-testid="buy-form" data-inscription-target="form">
                                                <% if (order.status !=='pending' && order.status !=='confirmed' ) { %>
                                                    <% if ((config.optional_payments ?? []).length> 0) { %>
                                                        <div class="mb-6" data-testid="optional-payments">
                                                            <div class="text-sm text-white/40 mb-4">Additional payments
                                                            </div>
                                                            <div class="space-y-3">
                                                                <% config.optional_payments.forEach((payment, index)=> {
                                                                    %>
                                                                    <label class="flex items-start gap-4 cursor-pointer"
                                                                        data-testid="optional-payment">
                                                                        <input
                                                                            class="mt-1 h-4 w-4 rounded border-white/20 bg-transparent"
                                                                            type="checkbox"
                                                                            data-inscription-target="optionalPayment"
                                                                            data-payment='<%= JSON.stringify(payment) %>'
                                                                            data-action="inscription#calculateCost" />
                                                                        <div class="flex-1">
                                                                            <div
                                                                                class="flex items-center justify-between gap-4">
                                                                                <span class="text-sm text-white/80">
                                                                                    <%= payment.title %>
                                                                                </span>
                                                                                <span class="price text-sm">
                                                                                    <%= formatSats(payment.amount) %>
                                                                                </span>
                                                                            </div>
                                                                            <div class="mt-1 text-sm text-white/40">
                                                                                <%= payment.description %>
                                                                            </div>
                                                                        </div>
                                                                    </label>
                                                                    <% }) %>
                                                            </div>
                                                        </div>
                                                        <div class="divider mb-6"></div>
                                                        <% } %>

                                                            <div class="space-y-4" data-testid="fees"
                                                                data-inscription-target="fees">
                                                                <div class="flex items-center justify-between text-sm">
                                                                    <span class="text-white/40">Network fee</span>
                                                                    <span class="text-white/60"><span
                                                                            data-inscription-target="fee">-</span></span>
                                                                </div>
                                                                <div class="flex items-center justify-between">
                                                                    <span class="text-sm text-white/60">Total</span>
                                                                    <span class="price text-lg"><span
                                                                            data-inscription-target="total">-</span></span>
                                                                </div>
                                                            </div>
                                                            <% } %>

                                                                <div class="mt-6">
                                                                    <% if (order.status==='pending' ||
                                                                        order.status==='confirmed' ) { %>
                                                                        <button
                                                                            class="w-full rounded-lg py-3 text-sm text-white/40 cursor-not-allowed"
                                                                            type="button" data-testid="buy-button"
                                                                            disabled>
                                                                            <%= order.status==='pending'
                                                                                ? 'Purchase Pending' : 'Sold' %>
                                                                        </button>
                                                                        <% } else { %>
                                                                            <button
                                                                                class="hide-on-connected w-full rounded-lg border border-white/10 py-3 text-sm text-white/40 cursor-not-allowed"
                                                                                type="button"
                                                                                data-inscription-target="connectButton"
                                                                                disabled>Connect wallet to buy</button>

                                                                            <button
                                                                                class="show-on-connected w-full btn-primary rounded-lg py-3 text-sm"
                                                                                type="button"
                                                                                data-inscription-target="prepareButton"
                                                                                data-action="click->inscription#prepare">
                                                                                <span
                                                                                    class="inline-flex items-center justify-center gap-2">
                                                                                    <span
                                                                                        data-inscription-target="prepareSpinner"
                                                                                        class="button-spinner button-spinner-hidden"></span>
                                                                                    <span
                                                                                        data-inscription-target="prepareLabel">Prepare
                                                                                        Purchase</span>
                                                                                </span>
                                                                            </button>

                                                                            <button
                                                                                class="hidden w-full btn-secondary rounded-lg py-3 text-sm"
                                                                                type="button" data-testid="buy-button"
                                                                                data-inscription-target="buyButton"
                                                                                data-action="click->inscription#buy">
                                                                                <span
                                                                                    class="inline-flex items-center justify-center gap-2">
                                                                                    <span
                                                                                        data-inscription-target="buySpinner"
                                                                                        class="button-spinner button-spinner-hidden"></span>
                                                                                    <span
                                                                                        data-inscription-target="buyLabel">Complete
                                                                                        Purchase</span>
                                                                                </span>
                                                                            </button>
                                                                            <% } %>
                                                                </div>
                                            </form>
                                        </div>
                                        <% } %>

                                            <!-- Details -->
                                            <div data-testid="details">
                                                <div class="text-sm text-white/40 mb-4">Details</div>
                                                <dl class="space-y-4 text-sm" data-testid="details-grid">
                                                    <div class="flex justify-between gap-4" data-testid="detail-id">
                                                        <dt class="text-white/40">ID</dt>
                                                        <dd><a class="font-mono text-white/60 hover:text-white transition-colors truncate max-w-[200px] block"
                                                                href="https://ordinals.com/inscription/<%= encodeURIComponent(inscription.id) %>"
                                                                target="_blank" rel="noopener"
                                                                data-testid="detail-id-link">
                                                                <%= inscription.id %>
                                                            </a></dd>
                                                    </div>
                                                    <div class="flex justify-between gap-4" data-testid="detail-number">
                                                        <dt class="text-white/40">Number</dt>
                                                        <dd><a class="font-mono text-white/60 hover:text-white transition-colors"
                                                                href="https://ordinals.com/inscription/<%= encodeURIComponent(inscription.id) %>"
                                                                target="_blank" rel="noopener"
                                                                data-testid="detail-number-link">#<%= inscription.number
                                                                    %></a></dd>
                                                    </div>
                                                    <div class="flex justify-between gap-4" data-testid="detail-sat">
                                                        <dt class="text-white/40">Sat</dt>
                                                        <dd><a class="font-mono text-white/60 hover:text-white transition-colors"
                                                                href="https://ordinals.com/sat/<%= encodeURIComponent(inscription.sat) %>"
                                                                target="_blank" rel="noopener"
                                                                data-testid="detail-sat-link">
                                                                <%= inscription.sat %>
                                                            </a></dd>
                                                    </div>
                                                    <% if (inscription.charmIcons.length> 0) { %>
                                                        <div class="flex justify-between gap-4"
                                                            data-testid="detail-charms">
                                                            <dt class="text-white/40">Charms</dt>
                                                            <dd class="flex gap-1" data-testid="detail-charms-icons">
                                                                <% inscription.charmIcons.forEach((icon)=> { %>
                                                                    <span>
                                                                        <%= icon %>
                                                                    </span>
                                                                    <% }) %>
                                                            </dd>
                                                        </div>
                                                        <% } %>
                                                            <div class="flex justify-between gap-4"
                                                                data-testid="detail-inscribed">
                                                                <dt class="text-white/40">Inscribed</dt>
                                                                <dd>
                                                                    <% const inscribedIso=new Date(inscription.timestamp
                                                                        * 1000).toISOString() %>
                                                                        <% const inscribedHuman=new
                                                                            Date(inscription.timestamp *
                                                                            1000).toLocaleDateString('en-US', {
                                                                            year: 'numeric' , month: 'short' ,
                                                                            day: 'numeric' , timeZone: 'UTC' }) %>
                                                                            <time class="text-white/60"
                                                                                datetime="<%= inscribedIso %>"
                                                                                data-testid="detail-inscribed-value">
                                                                                <%= inscribedHuman %>
                                                                            </time>
                                                                </dd>
                                                            </div>
                                                </dl>
                                            </div>

                                            <!-- Success/Error panels -->
                                            <div class="<%= (order.status === 'pending' || order.status === 'confirmed') ? '' : 'hidden' %> p-4 rounded-lg border border-white/10"
                                                data-inscription-target="successPanel" data-testid="buy-success">
                                                <div class="text-sm text-white/80"
                                                    data-inscription-target="successTitle">
                                                    <%= order.status==='pending' ? 'Purchase Pending' :
                                                        (order.status==='confirmed' ? 'Sold' : 'Success' ) %>
                                                </div>
                                                <a class="mt-2 block text-sm text-white/40 hover:text-white/60 transition-colors"
                                                    target="_blank" rel="noopener" data-inscription-target="successLink"
                                                    href="https://mempool.space/tx/<%= order.txid ?? '' %>">View
                                                    transaction →</a>
                                            </div>

                                            <div class="hidden p-4 rounded-lg border border-red-500/20"
                                                data-inscription-target="errorPanel" data-testid="buy-client-error">
                                                <div class="text-sm text-red-400" data-inscription-target="errorTitle">
                                                    Error</div>
                                                <div class="mt-1 text-sm text-white/50"
                                                    data-inscription-target="errorMessage"></div>
                                            </div>
                        </div>
                    </div>
</section>